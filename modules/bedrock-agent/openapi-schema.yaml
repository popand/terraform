openapi: 3.0.0
info:
  title: Terraform Agent API
  version: 1.0.0
  description: API for Terraform infrastructure management

paths:
  /read-files:
    get:
      summary: Read Terraform files from S3
      description: Retrieves .tf files from the S3 bucket for analysis
      operationId: readTerraformFiles
      responses:
        "200":
          description: Files retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: string
                    description: List of Terraform files
                  count:
                    type: string
                    description: Number of files found

  /analyze:
    get:
      summary: Analyze Terraform code
      description: Parse and extract resources, modules, and variables from Terraform files
      operationId: analyzeTerraformModule
      responses:
        "200":
          description: Analysis complete
          content:
            application/json:
              schema:
                type: object
                properties:
                  resources:
                    type: string
                    description: List of resources found
                  modules:
                    type: string
                    description: List of modules found
                  variables:
                    type: string
                    description: List of variables found

  /generate-docs:
    get:
      summary: Generate and save documentation to S3
      description: Creates markdown documentation from analyzed Terraform code and saves to S3
      operationId: generateDocumentation
      responses:
        "200":
          description: Documentation saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  s3Uri:
                    type: string
                    description: S3 URI of generated documentation
                  status:
                    type: string
                    description: Status of documentation generation

  /terraform-operation:
    get:
      summary: Execute Terraform operation
      description: Run terraform plan, apply, destroy, or validate via CodeBuild. Operation can be plan, apply, destroy, validate, output, or state.
      operationId: executeTerraformOperation
      parameters:
        - name: operation
          in: query
          description: Operation type to execute - plan, apply, destroy, validate, output, or state
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Operation started
          content:
            application/json:
              schema:
                type: object
                properties:
                  buildId:
                    type: string
                    description: CodeBuild build ID
                  status:
                    type: string
                    description: Status of the operation
                  message:
                    type: string
                    description: Additional message

  /get-status:
    get:
      summary: Get deployment status
      description: Check CodeBuild status and infrastructure state
      operationId: getTerraformStatus
      responses:
        "200":
          description: Status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  buildStatus:
                    type: string
                    description: Current build status
                  outputs:
                    type: string
                    description: Terraform outputs
                  resources:
                    type: string
                    description: List of resources

  /modify-code:
    get:
      summary: Modify Terraform files
      description: Make changes to Terraform code. Action can be add, update, or delete.
      operationId: modifyTerraformCode
      parameters:
        - name: filePath
          in: query
          description: Path to the Terraform file to modify
          required: true
          schema:
            type: string
        - name: action
          in: query
          description: Modification action - add, update, or delete
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Modification result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    description: Status of modification
                  changes:
                    type: string
                    description: List of changes made
                  preview:
                    type: string
                    description: Preview of changes

  /run-tests:
    get:
      summary: Run infrastructure tests
      description: Validate deployed infrastructure with automated tests. Test suite can be quick, connectivity, vpn, services, or full.
      operationId: runInfrastructureTests
      responses:
        "200":
          description: Test results
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    description: Overall test status
                  passed:
                    type: string
                    description: Number of tests passed
                  failed:
                    type: string
                    description: Number of tests failed
                  summary:
                    type: string
                    description: Test summary
