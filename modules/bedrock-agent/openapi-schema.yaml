openapi: 3.0.0
info:
  title: Terraform Agent API
  version: 1.0.0
  description: API for Terraform infrastructure management

paths:
  /read-files:
    get:
      operationId: readTerraformFiles
      summary: Read Terraform files from S3
      description: Retrieves .tf files from the S3 bucket for analysis
      parameters:
        - name: prefix
          in: query
          description: S3 prefix path to filter files
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Files retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        content:
                          type: string
                  count:
                    type: integer

  /analyze:
    get:
      operationId: analyzeTerraformModule
      summary: Analyze Terraform code
      description: Parse and extract resources, modules, and variables from Terraform files
      parameters:
        - name: file_path
          in: query
          description: Path to the Terraform file to analyze
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Analysis complete
          content:
            application/json:
              schema:
                type: object
                properties:
                  resources:
                    type: array
                    items:
                      type: string
                  modules:
                    type: array
                    items:
                      type: string
                  variables:
                    type: array
                    items:
                      type: string

  /generate-docs:
    get:
      operationId: generateDocumentation
      summary: Generate and save documentation to S3
      description: Creates markdown documentation from analyzed Terraform code and saves to S3
      parameters:
        - name: format
          in: query
          description: Output format (markdown, json)
          required: false
          schema:
            type: string
            default: markdown
      responses:
        '200':
          description: Documentation saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  s3_uri:
                    type: string
                  status:
                    type: string

  /terraform-operation:
    get:
      operationId: executeTerraformOperation
      summary: Execute Terraform operation
      description: Run terraform plan, apply, destroy, or validate via CodeBuild
      parameters:
        - name: operation
          in: query
          description: Operation type (plan, apply, destroy, validate, output, state)
          required: true
          schema:
            type: string
            enum:
              - plan
              - apply
              - destroy
              - validate
              - output
              - state
        - name: auto_approve
          in: query
          description: Auto-approve for apply/destroy operations (requires explicit true)
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Operation started
          content:
            application/json:
              schema:
                type: object
                properties:
                  build_id:
                    type: string
                  status:
                    type: string
                  message:
                    type: string

  /get-status:
    get:
      operationId: getTerraformStatus
      summary: Get deployment status
      description: Check CodeBuild status and infrastructure state
      parameters:
        - name: build_id
          in: query
          description: CodeBuild build ID to check status
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  build_status:
                    type: string
                  outputs:
                    type: object
                  resources:
                    type: array
                    items:
                      type: string

  /modify-code:
    get:
      operationId: modifyTerraformCode
      summary: Modify Terraform files
      description: Make changes to Terraform code (add, update, delete resources)
      parameters:
        - name: file_path
          in: query
          description: Path to the Terraform file to modify
          required: true
          schema:
            type: string
        - name: action
          in: query
          description: Modification action (add, update, delete)
          required: true
          schema:
            type: string
            enum:
              - add
              - update
              - delete
        - name: resource_type
          in: query
          description: Type of resource to modify
          required: false
          schema:
            type: string
        - name: dry_run
          in: query
          description: Preview changes without applying
          required: false
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Modification result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  changes:
                    type: array
                    items:
                      type: string
                  preview:
                    type: string

  /run-tests:
    get:
      operationId: runInfrastructureTests
      summary: Run infrastructure tests
      description: Validate deployed infrastructure with automated tests
      parameters:
        - name: test_suite
          in: query
          description: Test suite to run (quick, connectivity, vpn, services, full)
          required: false
          schema:
            type: string
            enum:
              - quick
              - connectivity
              - vpn
              - services
              - full
            default: quick
      responses:
        '200':
          description: Test results
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  passed:
                    type: integer
                  failed:
                    type: integer
                  summary:
                    type: string
