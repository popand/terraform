openapi: 3.0.0
info:
  title: Terraform Agent API
  version: 1.0.0
  description: API for Terraform infrastructure management

paths:
  /read-files:
    get:
      summary: Read Terraform files from S3
      description: Retrieves .tf files from the S3 bucket for analysis
      operationId: readTerraformFiles
      responses:
        "200":
          description: Files retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: string
                    description: List of Terraform files
                  count:
                    type: string
                    description: Number of files found

  /analyze:
    get:
      summary: Analyze Terraform code
      description: Parse and extract resources, modules, and variables from Terraform files
      operationId: analyzeTerraformModule
      responses:
        "200":
          description: Analysis complete
          content:
            application/json:
              schema:
                type: object
                properties:
                  resources:
                    type: string
                    description: List of resources found
                  modules:
                    type: string
                    description: List of modules found
                  variables:
                    type: string
                    description: List of variables found

  /generate-docs:
    get:
      summary: Generate infrastructure documentation
      description: Reads Terraform files from S3 and creates a concise markdown summary. This endpoint handles file reading internally - do NOT call read-files first. Returns markdown documentation with Overview, Key Components, Network Design, Security, and Outputs sections.
      operationId: generateDocumentation
      responses:
        "200":
          description: Documentation generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  documentation:
                    type: string
                    description: Markdown formatted documentation summary
                  status:
                    type: string
                    description: Status of documentation generation

  /terraform-operation:
    get:
      summary: Execute Terraform operation
      description: Run terraform plan, apply, destroy, or validate via CodeBuild. Operation can be plan, apply, destroy, validate, output, or state.
      operationId: executeTerraformOperation
      parameters:
        - name: operation
          in: query
          description: Operation type to execute - plan, apply, destroy, validate, output, or state
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Operation started
          content:
            application/json:
              schema:
                type: object
                properties:
                  buildId:
                    type: string
                    description: CodeBuild build ID
                  status:
                    type: string
                    description: Status of the operation
                  message:
                    type: string
                    description: Additional message

  /get-status:
    get:
      summary: Get deployment status
      description: Check CodeBuild status and infrastructure state
      operationId: getTerraformStatus
      responses:
        "200":
          description: Status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  buildStatus:
                    type: string
                    description: Current build status
                  outputs:
                    type: string
                    description: Terraform outputs
                  resources:
                    type: string
                    description: List of resources

  /modify-code:
    get:
      summary: Modify Terraform files
      description: Make changes to Terraform code. Action can be add, update, or delete.
      operationId: modifyTerraformCode
      parameters:
        - name: filePath
          in: query
          description: Path to the Terraform file to modify
          required: true
          schema:
            type: string
        - name: action
          in: query
          description: Modification action - add, update, or delete
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Modification result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    description: Status of modification
                  changes:
                    type: string
                    description: List of changes made
                  preview:
                    type: string
                    description: Preview of changes

  /run-tests:
    get:
      summary: Run infrastructure tests
      description: Validate deployed infrastructure with automated tests. Test suite can be quick, connectivity, vpn, services, or full.
      operationId: runInfrastructureTests
      responses:
        "200":
          description: Test results
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    description: Overall test status
                  passed:
                    type: string
                    description: Number of tests passed
                  failed:
                    type: string
                    description: Number of tests failed
                  summary:
                    type: string
                    description: Test summary

  /generate-diagram:
    get:
      summary: Generate architecture diagram
      description: Reads Terraform files and generates a Mermaid diagram of the infrastructure architecture. The diagram is returned as Mermaid code that can be rendered visually. Diagram types available are architecture (default), network, security, or compute.
      operationId: generateArchitectureDiagram
      parameters:
        - name: diagram_type
          in: query
          description: Type of diagram to generate - architecture (full infrastructure), network (VPCs, subnets, routing), security (firewalls, security groups), or compute (EC2, servers)
          required: false
          schema:
            type: string
            default: architecture
      responses:
        "200":
          description: Diagram generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  diagram:
                    type: string
                    description: Mermaid diagram code that can be rendered visually
                  diagram_type:
                    type: string
                    description: Type of diagram generated
                  format:
                    type: string
                    description: Diagram format (mermaid)
                  message:
                    type: string
                    description: Status message

  /get-deployed-resources:
    get:
      summary: Get deployed infrastructure resources
      description: Retrieves details about currently deployed AWS resources from Terraform state and live AWS. Returns resource information including instance IPs, VPC details, security groups, and current status. Use this when user asks about what is deployed, running instances, IPs, or current infrastructure state.
      operationId: getDeployedResources
      parameters:
        - name: resource_type
          in: query
          description: Optional filter by resource type (e.g., instance, vpc, subnet, security_group)
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Deployed resources retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    description: Deployment status (deployed or not_deployed)
                  summary:
                    type: string
                    description: Human-readable summary of deployed resources
                  resource_count:
                    type: string
                    description: Total number of resources
                  resources_by_type:
                    type: string
                    description: Resources grouped by type
                  resources:
                    type: string
                    description: Full list of resources with details
