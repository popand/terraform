openapi: 3.0.0
info:
  title: Terraform Agent API
  version: 1.0.0
  description: API for Terraform infrastructure management

paths:
  /read-files:
    post:
      operationId: readTerraformFiles
      summary: Read Terraform files from S3
      description: Retrieves .tf files from the S3 bucket for analysis
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                prefix:
                  type: string
                  description: S3 prefix path
      responses:
        '200':
          description: Files retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: array
                    items:
                      type: object
                  count:
                    type: integer

  /analyze:
    post:
      operationId: analyzeTerraformModule
      summary: Analyze Terraform code
      description: Parse and extract resources from Terraform files
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
                  description: Terraform file content
              required:
                - content
      responses:
        '200':
          description: Analysis complete
          content:
            application/json:
              schema:
                type: object
                properties:
                  resources:
                    type: array
                  modules:
                    type: array
                  variables:
                    type: array

  /generate-docs:
    post:
      operationId: generateDocumentation
      summary: Save documentation to S3
      description: Saves markdown documentation to S3 bucket
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
                  description: Documentation content
              required:
                - content
      responses:
        '200':
          description: Documentation saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  s3_uri:
                    type: string

  /terraform-operation:
    post:
      operationId: executeTerraformOperation
      summary: Execute Terraform operation
      description: Run plan, apply, destroy via CodeBuild
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                operation:
                  type: string
                  description: Operation type (plan, apply, destroy, validate)
                auto_approve:
                  type: boolean
                  description: Required for apply/destroy
              required:
                - operation
      responses:
        '200':
          description: Operation started
          content:
            application/json:
              schema:
                type: object
                properties:
                  build_id:
                    type: string
                  status:
                    type: string

  /get-status:
    post:
      operationId: getTerraformStatus
      summary: Get deployment status
      description: Check build status and infrastructure state
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                build_id:
                  type: string
                  description: Build ID to check
      responses:
        '200':
          description: Status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  outputs:
                    type: object

  /modify-code:
    post:
      operationId: modifyTerraformCode
      summary: Modify Terraform files
      description: Make changes to Terraform code
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                file:
                  type: string
                  description: File to modify
                action:
                  type: string
                  description: Action type
                content:
                  type: string
                  description: New content
                dry_run:
                  type: boolean
                  description: Preview only
              required:
                - file
                - action
      responses:
        '200':
          description: Modification result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  changes:
                    type: array

  /run-tests:
    post:
      operationId: runInfrastructureTests
      summary: Run infrastructure tests
      description: Validate deployed infrastructure
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                test_suite:
                  type: string
                  description: Test suite (quick, connectivity, vpn, full)
      responses:
        '200':
          description: Test results
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  summary:
                    type: object
